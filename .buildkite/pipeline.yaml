# Generated by: aspect workflows migrate --host=buildkite
# Source: .aspect/workflows/config_aws.yaml
# DO NOT EDIT - regenerate with 'aspect workflows migrate'

env:
  ASPECT_DEBUG: "1"
steps:
  - key: __main__::warm
    label: ":aspect: Building CLI"
    agents:
      queue: aspect-huge
    timeout_in_minutes: 20
    retry:
      automatic:
        - exit_status: 78
          limit: 1
    command:
      - echo "Pre-command builds and uploads CLI to remote cache"
  - key: __main__::test
    depends_on:
      - __main__::warm
    label: ":aspect: Test"
    agents:
      queue: aspect-default
    timeout_in_minutes: 20
    retry:
      automatic:
        - exit_status: 78
          limit: 1
    command:
      - |
        echo "--- :bazel: aspect test //..."
        ASPECT_DEBUG=1 aspect test //... --bazel_flag=--build_tests_only
  - key: __main__::build
    depends_on:
      - __main__::warm
    label: ":aspect: Build"
    agents:
      queue: aspect-huge
    timeout_in_minutes: 20
    retry:
      automatic:
        - exit_status: 78
          limit: 1
    command:
      - |
        echo "--- :bazel: aspect build //:launcher //:cli"
        aspect build //:launcher //:cli
        # Use cquery to get the actual output paths (handles platform transitions on Linux)
        WORKSPACE_ROOT=$$(pwd)
        LAUNCHER=$$WORKSPACE_ROOT/$$(bazel $$BAZEL_STARTUP_OPTS cquery $$BAZEL_BUILD_OPTS --output=files //crates/aspect-launcher)
        CLI=$$WORKSPACE_ROOT/$$(bazel $$BAZEL_STARTUP_OPTS cquery $$BAZEL_BUILD_OPTS --output=files //crates/aspect-cli)
        echo "--- :aspect: aspect tests axl"
        $$LAUNCHER tests axl
        echo "--- :aspect: aspect demo template-demo"
        $$LAUNCHER demo template-demo
        echo "--- :aspect: aspect user user_task"
        $$LAUNCHER user user_task
        echo "--- :aspect: aspect user user_task_reexport"
        $$LAUNCHER user user_task_reexport
        echo "--- :aspect: aspect user user-task-manual"
        $$LAUNCHER user user-task-manual
        echo "--- :aspect: aspect user user-task-added-by-config"
        $$LAUNCHER user user-task-added-by-config
        echo "--- :aspect: aspect user user-task-subdir (in crates/aspect-cli)"
        (
          cd crates/aspect-cli
          $$LAUNCHER user user-task-subdir
        )
        echo "--- :aspect: aspect help"
        $$LAUNCHER help
        echo "--- :aspect: aspect-launcher --version"
        $$LAUNCHER --version
        echo "--- :aspect: aspect-cli --version"
        $$CLI --version
        echo "--- :aspect: aspect version"
        $$LAUNCHER version
  - key: __main__::format
    label: ":broom: Format"
    depends_on:
      - __main__::warm
    agents:
      queue: aspect-default
    timeout_in_minutes: 20
    retry:
      automatic:
        - exit_status: 78
          limit: 1
    command:
      - |
        echo "--- :bazel: bazel run //tools/format:format.check"
        bazel $$BAZEL_STARTUP_OPTS run $$BAZEL_BUILD_OPTS //tools/format:format.check
  - key: __main__::delivery
    label: ":package: Delivery"
    depends_on:
      - __main__::warm
    agents:
      queue: aspect-default
    timeout_in_minutes: 20
    retry:
      automatic:
        - exit_status: 78
          limit: 1
    command:
      - aspect delivery --build_url $BUILDKITE_BUILD_URL --commit_sha $BUILDKITE_COMMIT --force_target //:hello -- //:hello //:hello2
