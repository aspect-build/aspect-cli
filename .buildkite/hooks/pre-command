#!/bin/sh
set -eu

ASPECT_BIN_DIR="$HOME/.aspect/bin"

# Skip if bazel is not installed
if ! command -v bazel >/dev/null 2>&1; then
  exit 0
fi

# Check if aspect binary exists
if [ -x "$ASPECT_BIN_DIR/aspect" ]; then
  # Skip if it's the new version (contains "programmable" in help)
  if "$ASPECT_BIN_DIR/aspect" --help 2>&1 | grep -q programmable; then
    exit 0
  fi
  # Remove old version
  rm -f "$ASPECT_BIN_DIR/aspect"
fi

# Build aspect-cli and install
echo "--- Building aspect-cli"
bazel build //:cli

# Create target directory and copy binary
mkdir -p "$ASPECT_BIN_DIR"
cp -f "$(bazel cquery --output=files //:cli 2>/dev/null)" "$ASPECT_BIN_DIR/aspect"
chmod 0755 "$ASPECT_BIN_DIR/aspect"

# Add to PATH for subsequent commands
export PATH="$ASPECT_BIN_DIR:$PATH"

echo "aspect-cli installed to $ASPECT_BIN_DIR/aspect"
