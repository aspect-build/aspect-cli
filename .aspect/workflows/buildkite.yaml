steps:
  - label: ":aspect: Test"
    agents:
      queue: aspect-default
    command: |
      echo "--- :aspect-build: Workflows environment"
      /etc/aspect/workflows/bin/configure_workflows_env
      echo "--- :stethoscope: Agent health check"
      /etc/aspect/workflows/bin/agent_health_check
      echo "--- :bazel: bazel test //..."
      pwd
      rosetta bazelrc > /etc/bazel.bazelrc
      bazel \
        --nohome_rc \
        --output_user_root=/mnt/ephemeral/bazel/aspect-cli/__main__ \
        --output_base=/mnt/ephemeral/output/aspect-cli/__main__ \
        test \
        --config=workflows \
        --config=ci \
        --test_output=summary \
        --show_progress_rate_limit=1 \
        -- //...
      echo "--- :bazel: bazel build //:launcher //:cli"
      bazel \
        --nohome_rc \
        --output_user_root=/mnt/ephemeral/bazel/aspect-cli/__main__ \
        --output_base=/mnt/ephemeral/output/aspect-cli/__main__ \
        build \
        --config=workflows \
        --config=ci \
        --test_output=summary \
        --show_progress_rate_limit=1 \
        --remote_download_outputs="toplevel" \
        -- //:launcher //:cli
      echo "--- :aspect: aspect tests axl"
      ./bazel-bin/crates/aspect-launcher/aspect-launcher tests axl
      echo "--- :aspect: aspect demo template-demo"
      ./bazel-bin/crates/aspect-launcher/aspect-launcher demo template-demo
      echo "--- :aspect: aspect user user_task"
      ./bazel-bin/crates/aspect-launcher/aspect-launcher user user_task
      echo "--- :aspect: aspect user user_task_reexport"
      ./bazel-bin/crates/aspect-launcher/aspect-launcher user user_task_reexport
      echo "--- :aspect: aspect user user-task-manual"
      ./bazel-bin/crates/aspect-launcher/aspect-launcher user user-task-manual
      echo "--- :aspect: aspect user user-task-added-by-config"
      ./bazel-bin/crates/aspect-launcher/aspect-launcher user user-task-added-by-config
      echo "--- :aspect: aspect user user-task-subdir (in crates/aspect-cli)"
      (
        cd crates/aspect-cli
        ../../bazel-bin/crates/aspect-launcher/aspect-launcher user user-task-subdir
      )
      echo "--- :aspect: aspect help"
      ./bazel-bin/crates/aspect-launcher/aspect-launcher help
      echo "--- :aspect: aspect-launcher --version"
      ./bazel-bin/crates/aspect-launcher/aspect-launcher --version
      echo "--- :aspect: aspect-cli --version"
      ./bazel-bin/crates/aspect-cli/aspect-cli --version
      echo "--- :aspect: aspect version"
      ./bazel-bin/crates/aspect-launcher/aspect-launcher version
  - label: ":broom: Format"
    agents:
      queue: aspect-small
    command: |
      echo "--- :aspect-build: Workflows environment"
      /etc/aspect/workflows/bin/configure_workflows_env
      echo "--- :stethoscope: Agent health check"
      /etc/aspect/workflows/bin/agent_health_check
      echo "--- :bazel: bazel run //tools/format:format.check"
      pwd
      rosetta bazelrc > /etc/bazel.bazelrc
      bazel \
        --nohome_rc \
        --output_user_root=/mnt/ephemeral/bazel/aspect-cli/__main__ \
        --output_base=/mnt/ephemeral/output/aspect-cli/__main__ \
        run \
        --config=workflows \
        --config=ci \
        --show_progress_rate_limit=1 \
        //tools/format:format.check
