load("./common.axl", "tui")

def _test_impl(ctx):
    stdout = ctx.std.io.stdout
    stderr = ctx.std.io.stderr
    test = ctx.bazel.build(
        build_events = True,
        command = "test",
        flags = [
            "--isatty=" + str(int(stdout.is_tty)),
            "--bes_outerr_buffer_size=1024",
            "--bes_outerr_chunk_size=1024",
            "--curses=yes"
        ],
        *ctx.args.targets
    )
    return tui(ctx, test)

test = task(
    implementation = _test_impl,
    args = {
        # TODO: Support a long --pattern_file like bazel does (@./targets)
        # TODO: Support - (list from stdin)
        "pattern": args.positional(default = ["..."]),
    }
)
